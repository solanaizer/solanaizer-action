---
name: 'Github Action for Solanaizer'
description: 'Solana Smart Contract Auditing using AI'

inputs:
  openapi-token:
    required: true

runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-python@v5
    with:
      python-version: '3.9'
      cache: 'pip'

  - run: pip install -r requirements.txt
    shell: bash

  - name: Comment on PR
    uses: actions/github-script@v7
    with:
      github-token: ${{ inputs.openapi-token }}
      script: |
        const execSync = require("child_process").execSync;
        const raw = execSync("python ./solanaizer.py", { encoding: "utf-8" });
        
        try {
          JSON.parse(raw);
        } catch(e) {
          console.log('INVALID JSON FORMAT FROM ðŸ:', raw)
          process.exit(1)
        }


        const data = JSON.parse(raw).map(line => ({
          ...line,
          severity: line.severity === "HIGH" ? "High ðŸ¥µ" : line.severity === "MEDIUM" ? "Medium ðŸ¤·ðŸ»â€â™‚ï¸" : "Low ðŸ˜—",
        }));
        
        const table = ["| Severity ðŸŒ¡ï¸  | Message ðŸ’­ | Error Code ðŸ˜¬ | Filename ðŸ“œ |"];
        table.push("| :-------------: | ------------- | :-------------: | ------------- |");
        
        if (data.length !== 0) {
          data.forEach(line => {
            table.push(
              `| ${line.severity} | ${line.message} | \`${line.errorCode}\`Â | \`${line.filename}\`<br>Lines: \`${
                line.lines.join(", ")
              }\` |`,
            );
          });
        }
        
        let body = `## Solanaizer Audit Results ðŸ¤–\n\nFind below all the vulnerabilities found in your smart contracts:`

        if (data.length !== 0) {
          body += `\n\n${table.join("\n")})}`
          body += '\n<img src="https://media0.giphy.com/media/Xyj49ooQtsFD16z27J/giphy.gif"/>'
          console.table(data);
        } else {
          body += '\n\n0 vulnerabilities found!\n\n<img src="https://media0.giphy.com/media/Ogak8XuKHLs6PYcqlp/giphy.gif"/>'
          console.log('No vulnerabilities ðŸ˜˜')
        }

        github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body,
        });
      
        if (data.length !== 0) {
          core.setFailed('Job run failed')
        }

branding:
  icon: lock
  color: black